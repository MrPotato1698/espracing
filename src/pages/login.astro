---
import Layout from "@/layouts/NormalLayout.astro";
import OpenEye from "@/icons/OpenEye.astro";
import CloseEye from "@/icons/CloseEye.astro";
import GoogleColor from "@/icons/GoogleColor.astro";

const { cookies, redirect, url } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");


// Obtener parámetros de error de la URL
const errorMessages = {
  no_code: "Error en la autenticación: código no recibido",
  session_exchange_failed: "Error al procesar la autenticación",
  unexpected_error: "Error inesperado durante la autenticación",
  oauth_error: "Error al iniciar sesión con Google"
};
type ErrorParam = keyof typeof errorMessages;
const errorParam = url.searchParams.get("error") as ErrorParam | null;

function handleRedirect() {
  if (accessToken && refreshToken) {
    redirect("/myprofile");
  }
}
handleRedirect();
---

<Layout title="ESP Racing: Login">
  <div
    class="absolute bottom-0 left-0 w-full h-full overflow-hidden leading-5 bg-[#f0f0f0] top-72 -z-10 bg-gradient-to-b from-primary via-primary to-darkPrimary"
  >
  </div>
  <div
    class="relative justify-center min-h-screen bg-transparent shadow-xl sm:flex sm:flex-row rounded-3xl"
  >
    <div
      class="z-10 flex flex-col self-center lg:px-14 sm:max-w-4xl xl:max-w-md"
    >
      <div class="flex-col self-start hidden text-lightPrimary lg:flex">
        <h1 class="my-3 text-4xl font-semibold">Bienvenido de vuelta</h1>
        <p class="pr-3 text-sm opacity-90">
          En ESP Racing nos alegra volver a verte de nuevo por aquí, esperando a que
          disfrutes de las mejores carreras que puedes encontrar.
        </p>
      </div>
    </div>

    <div class="z-10 flex self-center justify-center">
      <div class="p-12 mx-auto bg-lightPrimary rounded-3xl w-96">
        <div class="mb-7">
          <h3 class="text-2xl font-semibold text-gray-800">Inicia Sesión</h3>
          <p class="text-gray-400">
            ¿Aun no tienes cuenta? <a
              href="/register"
              class="text-sm text-darkPrimary hover:text-primary">Registrate</a
            >
          </p>
        </div>

        <!-- Mostrar errores si existen -->
        {errorParam && errorMessages[errorParam] && (
          <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
            {errorMessages[errorParam]}
          </div>
        )}

        <div class="space-y-6">
          <!-- Formulario para email/password -->
          <form id="emailLoginForm">
            <div class="space-y-6">
              <div class="">
                <input
                  class="w-full px-4 py-3 text-sm text-darkPrimary bg-gray-200 border border-gray-200 rounded-lg focus:bg-gray-100 focus:outline-none focus:border-darkPrimary focus:text-darkSecond"
                  type="email"
                  name="email"
                  id="email"
                  placeholder="Email"
                  required
                />
              </div>
              <div class="relative" x-data="{ show: true }">
                <input
                  :type="show ? 'password' : 'text'"
                  name="password"
                  id="password"
                  class="w-full px-4 py-3 text-sm text-darkPrimary bg-gray-200 border border-gray-200 rounded-lg focus:bg-gray-100 focus:outline-none focus:border-darkPrimary focus:text-darkSecond"
                  placeholder="Contraseña"
                  required
                />
                <div
                  class="absolute inset-y-0 right-0 flex items-center mr-3 text-sm leading-5 cursor-pointer"
                  @click="show = !show"
                >
                  <OpenEye x-show="show" />
                  <CloseEye x-show="!show" />
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div class="ml-auto text-sm">
                  <a href="/recoverpassword" class="text-darkPrimary hover:text-primary">
                    ¿Olvidaste tu contraseña?
                  </a>
                </div>
              </div>
              <div>
                <button
                  type="submit"
                  class="flex justify-center w-full p-3 font-semibold tracking-wide text-gray-100 transition duration-300 ease-in bg-primary border-2 border-lightPrimary rounded-lg cursor-pointer hover:border-primary hover:bg-lightPrimary hover:text-primary disabled:opacity-50"
                  id="emailSubmitBtn"                >
                  Inicia Sesión
                </button>
              </div>
            </div>
          </form>

          <div class="flex items-center justify-center my-5 space-x-2">
            <span class="w-8 h-px bg-gray-100"></span>
            <span class="font-normal text-gray-300">o inicia sesión también</span>
            <span class="w-8 h-px bg-gray-100"></span>
          </div>

          <!-- Botón separado para Google -->
          <div class="flex justify-center w-full gap-5">
            <button
              id="googleLogin"
              type="button"
              class="flex items-center justify-center w-full p-3 mb-6 text-sm font-medium tracking-wide text-gray-500 transition duration-300 ease-in border border-gray-300 rounded-lg cursor-pointer md:mb-0 hover:border-lightPrimary hover:bg-[#EA4335] hover:text-lightPrimary disabled:opacity-50"            >
              <GoogleColor />
              <span class="ml-2">Google</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script
  is:inline
  data-astro-rerun
  src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.js"
></script>

<script is:inline data-astro-rerun>
  // Manejo del formulario de email/password
  const emailForm = document.getElementById('emailLoginForm');
  const googleBtn = document.getElementById('googleLogin');

  if (emailForm) {
    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(emailForm);

      try {
        const response = await fetch('/api/auth/signin', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error);
        }

        // Redireccionar en caso de éxito
        window.location.href = '/myprofile';
      } catch (error) {
        alert(error.message || 'Error al iniciar sesión');
      }
    });
  }

  // Manejo del botón de Google (redirección directa)
  if (googleBtn) {
    googleBtn.addEventListener('click', async () => {
      try {
        // Redirigir directamente al endpoint de OAuth
        window.location.href = '/api/auth/google';
      } catch (error) {
        console.error('Error al iniciar sesión con Google:', error);
        alert('Error al iniciar sesión con Google');
      }
    });
  }
</script>
