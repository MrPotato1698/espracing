---
import Layout from "@/layouts/ProfileLayout.astro";
import { supabase } from "@/lib/supabase";
import type { Database, Tables } from "../../database.types";
import type { QueryData } from "@supabase/supabase-js";

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return redirect("/login");
}

const { data: {user}, error } = await supabase.auth.setSession({
  refresh_token: refreshToken.value,
  access_token: accessToken.value,
});

if (error) {
  cookies.delete("sb-access-token", {
    path: "/",
  });
  cookies.delete("sb-refresh-token", {
    path: "/",
  });

  return redirect("/login");
}

const { data } = await supabase
  .from("profiles")
  .select("*, team (name)")
  .eq("id", user?.id);

const profile = data ? (data[0] as Tables<'profiles'>) : null;

---

<!-- <h1>Bienvenido {email}</h1> -->
<Layout title = "ESP Racing: Mi Perfil">
  <div class = "border-y-2 border-blue-500 ml-64">
    <h2>Mi Perfil</h2>

      <img src = {profile?.avatar ?(profile.avatar):""} alt = "Avatar" />
      <div class = "blockprofile">
        <div class = "blockdata">
          <h3>Nombre</h3>
          {
            profile?.[0]full_name ?(
              <p>{profile.full_name}</p>
            ) : (
              <p>No hay nombre</p>
            )
          }
        </div>

        <div class = "blockdata">
          <h3>Steam ID</h3>
          {
            profile?.steam_id ?(
              <p>{profile.steam_id}</p>
            ) : (
              <p>No hay Steam ID</p>
            )
          }
        </div>

        <div class = "blockdata">
          <h3>Equipo</h3>
          {
            profile?.team ?(
              <p>{profile.team}</p>
            ) : (
              <p>No hay Equipo</p>
            )
          }
        </div>

      </div>
  </div>
</Layout>

<script>
  import { supabase } from "@/lib/supabase";
  import type { Database } from "../../database.types";
  async function getProfile(id: string) {
  const { data, error } = await supabase
    .from ('profiles')
    .select("*")
    .eq("id", id);
  }


</script>
