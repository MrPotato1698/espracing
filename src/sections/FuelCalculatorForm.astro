---
import { supabase } from "@/db/supabase";

const { data: carsData } = await supabase
  .from("car")
  .select("id, filename, carbrand!inner(name), model, tyreTimeChange, fuelLiterTime, maxLiter")
  .gt("tyreTimeChange", 0)
  .gt("fuelLiterTime", 0)
  .gt("maxLiter", 0)
  .order("id", { ascending: true });

const carList = carsData?.sort((a, b) => {
  const brandComparison = (a.carbrand?.name ?? '').localeCompare(b.carbrand?.name ?? '');
  if (brandComparison === 0) {
    return (a.model ?? '').localeCompare(b.model ?? '');
  }
  return brandComparison;
});
---

<div class="box-border p-5 m-auto bg-white rounded-md max-w-screen-2xl">
  <form id="fuelForm">
    <label class="text-darkPrimary text-lg font-medium" for="carname"
      >Eliga coche</label
    >
    <select
      class="w-full p-3 border border-solid border-darkSecond rounded-md mt-2 mb-4 resize-y text-black bg-lightPrimary"
      id="carname"
      name="carname"
    >
      {
        (carList ?? []).map((car) => (
          <option value={car.filename?.toString()}>
            {car.carbrand?.name} {car.model}
          </option>
        ))
      }
      <option value="othercar">- No está en la lista </option>
    </select>

    <div id="otherCarFuelTank" style="display: none;">
      <label class="text-darkPrimary text-lg font-medium" for="fuelTankCapacity">
        Capacidad del tanque de combustible (en litros)
      </label>
      <input
        class="w-full p-3 border border-solid border-darkSecond rounded-md mt-2 mb-4 resize-y text-darkPrimary bg-lightPrimary"
        type="number"
        id="fuelTankCapacity"
        name="fuelTankCapacity"
        step="1"
        min="0"
        title="Usa solo números y puntos para los decimales."
        placeholder="ej: 60"
      />
    </div>

    <label class="text-darkPrimary text-lg font-medium" for="fuelConsumption"
      >Consumo del coche (Litros por vuelta)</label
    >
    <input
      class="w-full p-3 border border-solid border-darkSecond rounded-md mt-2 mb-4 resize-y text-darkPrimary bg-lightPrimary"
      type="number"
      id="fuelConsumption"
      name="fuelConsumption"
      step="0.01"
      min="0"
      title="Usa solo números y puntos para los decimales."
      placeholder="ej: 1.32"
    />

    <div class="flex items-center gap-2">
      <label class="relative inline-flex cursor-pointer">
        <input id="switch-2" type="checkbox" class="peer sr-only" />
        <label for="switch-2" class="hidden"></label>
        <div
          class="peer h-4 w-11 rounded-full border bg-slate-200 after:absolute after:-top-1 after:left-0 after:h-6 after:w-6 after:rounded-full after:border after:border-gray-300 after:bg-lightPrimary after:transition-all after:content-[''] peer-checked:bg-primary peer-checked:after:translate-x-full peer-focus:ring-primary"
        >
        </div>
      </label>
      <label class="text-darkPrimary text-lg font-medium" for="switch-2"
        >¿Duración de carrera en tiempo o vueltas?</label
      >
    </div>

    <div class="grid grid-cols-2">
      <div id="timeContainer">
        <label class="text-darkPrimary text-lg font-medium" for="racedurationTime"
          >Duración de carrera (Horas/Minutos)</label
        >
        <div class="grid grid-cols-2 gap-2 max-w-2xl">
          <input
            class="w-full p-3 border border-solid border-darkSecond rounded-md mt-2 mb-4 resize-y text-darkPrimary bg-lightPrimary"
            type="number"
            id="racedurationTimeHours"
            name="racedurationTimeHours"
            step="1"
            min="0"
            title="Usa solo números."
            placeholder="Horas de carrera. (ej: 1)"
          />
          <input
            class="w-full p-3 border border-solid border-darkSecond rounded-md mt-2 mb-4 resize-y text-darkPrimary bg-lightPrimary"
            type="number"
            id="racedurationTimeMinutes"
            name="racedurationTimeMinutes"
            step="1"
            min="0"
            title="Usa solo números."
            placeholder="Minutos de Carrera. (ej: 30)"
          />
        </div>
      </div>

      <div id="lapsContainer" style="display: none;">
        <label class="text-darkPrimary text-lg font-medium" for="racedurationLaps"
          >Duración de carrera (en vueltas)</label
        >
        <div class="max-w-2xl">
          <input
            class="w-full p-3 border border-solid border-darkSecond rounded-md mt-2 mb-4 resize-y text-darkPrimary bg-lightPrimary"
            type="number"
            id="racedurationLaps"
            name="racedurationLaps"
            step="1"
            min="0"
            title="Usa solo números."
            placeholder="ej: 25"
          />
        </div>
      </div>

      <div>
        <label class="text-darkPrimary text-lg font-medium" for="laptime"
          >Tiempo por vuelta (Minutos/Segundos)</label
        >
        <div class="grid grid-cols-2 gap-2 max-w-2xl">
          <input
            class="w-full p-3 border border-solid border-darkSecond rounded-md mt-2 mb-4 resize-y text-darkPrimary bg-lightPrimary"
            type="number"
            id="laptimeMinutes"
            name="laptimeMinutes"
            step="1"
            min="0"
            title="Usa solo números."
            placeholder="Minutos (ej: 1)"
          />

          <input
            class="w-full p-3 border border-solid border-darkSecond rounded-md mt-2 mb-4 resize-y text-darkPrimary bg-lightPrimary"
            type="number"
            id="laptimeSeconds"
            name="laptimeSeconds"
            step="0.001"
            min="0"
            title="Usa solo números y puntos decimales."
            placeholder="Segundos. (ej: 30.542)"
          />
        </div>
      </div>
    </div>

    <input
      class="bg-primary text-white font-bold py-3 px-5 border-solid border-primary border-2 rounded-md hover:bg-lightPrimary hover:text-darkSecond mt-4"
      type="submit"
      value="Calcular"
    />
  </form>
</div>

<div
  class="mt-3 box-border p-5 m-auto bg-lightPrimary rounded-md max-w-screen-2xl text-darkPrimary"
  id="resultadoCalculo"
  style="display: none;"
>
</div>

<script>
  import { initializeFuelFormControls } from "@/lib/fuelForm/fuelFormDOMControl";

  // Inicializar los controles del formulario
  initializeFuelFormControls();

  // Reinicializar los controles del formulario al recargar la página
  document.addEventListener("astro:page-load", initializeFuelFormControls);
  document.addEventListener("submit", function (event) {});
</script>
